package com.example.policy.entity;

import lombok.Data;
import jakarta.persistence.*;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
@Entity
@Table(name = "claims")
public class Claim {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long claimId;

    private Long policyId;  // Link to user's issued policy (from policies table)

    private String claimType;  // e.g., Death, Maturity, Accident

    private BigDecimal claimAmount;

    private LocalDate claimDate;  // Auto set in service

    private String status = "Pending";  // Pending, Approved, Rejected

    private String remarks;  // Reason of Claim
}

-------

<!-- Claims Table -->
<changeSet id="004-claims" author="you">
    <createTable tableName="claims">
        <column name="claim_id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="policy_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
        <column name="claim_type" type="VARCHAR(50)"/>
        <column name="claim_amount" type="DECIMAL(15,2)"/>
        <column name="claim_date" type="DATE"/>
        <column name="status" type="VARCHAR(20)"/>
        <column name="remarks" type="VARCHAR(255)"/>
    </createTable>
</changeSet>

-------

<!-- Hardcoded 5 claims -->
<changeSet id="004-claims-data" author="you">
    <!-- Claim 1: Pending (Health Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="1"/>
        <column name="claim_type" value="Health Insurance"/>
        <column name="claim_amount" value="250000"/>
        <column name="claim_date" value="2026-01-20"/>
        <column name="status" value="Pending"/>
        <column name="remarks" value="Hospitalization due to illness"/>
    </insert>

    <!-- Claim 2: Approved (Motor Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="2"/>
        <column name="claim_type" value="Motor Insurance"/>
        <column name="claim_amount" value="800000"/>
        <column name="claim_date" value="2026-02-05"/>
        <column name="status" value="Approved"/>
        <column name="remarks" value="Vehicle damage approved"/>
    </insert>

    <!-- Claim 3: Rejected (Property/Home Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="3"/>
        <column name="claim_type" value="Property/Home Insurance"/>
        <column name="claim_amount" value="50000"/>
        <column name="claim_date" value="2026-02-09"/>
        <column name="status" value="Rejected"/>
        <column name="remarks" value="Rejected due to invalid documents"/>
    </insert>

    <!-- Claim 4: Pending (Life Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="4"/>
        <column name="claim_type" value="Life Insurance"/>
        <column name="claim_amount" value="120000"/>
        <column name="claim_date" value="2026-02-15"/>
        <column name="status" value="Pending"/>
        <column name="remarks" value="Life claim pending review"/>
    </insert>

    <!-- Claim 5: Pending (Health Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="5"/>
        <column name="claim_type" value="Health Insurance"/>
        <column name="claim_amount" value="95000"/>
        <column name="claim_date" value="2026-02-18"/>
        <column name="status" value="Pending"/>
        <column name="remarks" value="Health claim for surgery"/>
    </insert>
</changeSet>
------------------=================
// ClaimRepository.java (with custom functions)
package com.example.policy.repository;

import com.example.policy.entity.Claim;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;

public interface ClaimRepository extends JpaRepository<Claim, Long> {

    // Fetch all claims with policy (for full details)
    @Query("SELECT c FROM Claim c JOIN FETCH c.policy")
    List<Claim> findAllWithPolicy();

    // Fetch claims by userId (for "My Claims")
    @Query("SELECT c FROM Claim c JOIN FETCH c.policy p WHERE p.userId = :userId")
    List<Claim> findByUserId(@Param("userId") Long userId);

    // Fetch pending claims (for Approver)
    List<Claim> findByStatus(String status);
}
---------------

// ClaimService.java (with all functions, using Java Streams for mapping)
package com.example.policy.service;

import com.example.policy.entity.Claim;
import com.example.policy.dto.ClaimResponse;
import com.example.policy.entity.Policy;
import com.example.policy.repository.ClaimRepository;
import com.example.policy.repository.PolicyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ClaimService {

    @Autowired
    private ClaimRepository claimRepository;

    @Autowired
    private PolicyRepository policyRepository;

    // Submit claim (User)
    public ClaimResponse submitClaim(Claim claim) {
        if (claim.getPolicyId() == null) {
            throw new RuntimeException("Policy ID is required");
        }

        Policy policy = policyRepository.findById(claim.getPolicyId())
                .orElseThrow(() -> new RuntimeException("Policy not found"));

        claim.setPolicy(policy);
        claim.setClaimDate(LocalDate.now());
        claim.setStatus("Pending");

        Claim savedClaim = claimRepository.save(claim);
        return convertToResponse(savedClaim);
    }

    // Get all claims (Read-Only or Approver)
    public List<ClaimResponse> getAllClaims() {
        return claimRepository.findAllWithPolicy().stream()  // Java Streams for mapping
                .map(this::convertToResponse)
                .collect(Collectors.toList());
    }

    // Get my claims (User)
    public List<ClaimResponse> getMyClaims(Long userId) {
        return claimRepository.findByUserId(userId).stream()  // Java Streams for mapping
                .map(this::convertToResponse)
                .collect(Collectors.toList());
    }

    // Get pending claims (Approver)
    public List<ClaimResponse> getPendingClaims() {
        return claimRepository.findByStatus("Pending").stream()  // Java Streams for mapping
                .map(this::convertToResponse)
                .collect(Collectors.toList());
    }

    // Convert Claim to DTO
    private ClaimResponse convertToResponse(Claim claim) {
        Policy p = claim.getPolicy();
        return new ClaimResponse(
                claim.getClaimId(),
                p.getId(),
                p.getPlanName(),
                p.getInsuredAmount(),
                claim.getClaimType(),
                claim.getClaimAmount(),
                claim.getClaimDate(),
                claim.getStatus(),
                claim.getRemarks()
        );
    }

    // Approve claim (Approver)
    public String approveClaim(Long claimId, String remarks) {
        Claim claim = claimRepository.findById(claimId)
                .orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Approved");
        if (remarks != null && !remarks.trim().isEmpty()) {
            claim.setRemarks(remarks);
        }

        claimRepository.save(claim);
        return "Claim " + claimId + " approved";
    }

    // Reject claim (Approver)
    public String rejectClaim(Long claimId, String remarks) {
        Claim claim = claimRepository.findById(claimId)
                .orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Rejected");
        if (remarks != null && !remarks.trim().isEmpty()) {
            claim.setRemarks(remarks);
        }

        claimRepository.save(claim);
        return "Claim " + claimId + " rejected";
    }
}

------

package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
public class ClaimResponse {

    private Long claimId;
    private Long policyId;
    private String planName;
    private BigDecimal insuredAmount;
    private String claimType;
    private BigDecimal claimAmount;
    private LocalDate claimDate;
    private String status;
    private String remarks;

}
-----

package com.example.policy.controller;

import com.example.policy.entity.Claim;
import com.example.policy.service.ClaimService;
import com.example.policy.dto.ClaimResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import org.springframework.web.server.ResponseStatusException;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/claims")
public class ClaimController {

    @Autowired
    private ClaimService claimService;

    // User submits claim
    @PostMapping("/submit")
    public ClaimResponse submitClaim(@RequestBody Claim claim) {
        try {
            return claimService.submitClaim(claim);
        } catch (RuntimeException e) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, e.getMessage());
        }
    }

    // Retrieve all claims
    @GetMapping("/retrieve")
    public List<ClaimResponse> getAllClaims() {
        return claimService.getAllClaims();
    }

    // User views their claims
    @GetMapping("/my")
    public List<ClaimResponse> getMyClaims(@RequestHeader("userId") Long userId) {
        return claimService.getMyClaims(userId);
    }

    // Approver views pending claims
    @GetMapping("/pending")
    public List<ClaimResponse> getPendingClaims() {
        return claimService.getPendingClaims();
    }

    // Approver approves claim
    @PutMapping("/{claimId}/approve")
    public ResponseEntity<String> approveClaim(@PathVariable Long claimId, @RequestBody(required = false) Map<String, String> body) {
        try {
            String remarks = (body != null) ? body.get("remarks") : null;
            String message = claimService.approveClaim(claimId, remarks);
            return ResponseEntity.ok(message);
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Error: " + e.getMessage());
        }
    }

    // Approver rejects claim
    @PutMapping("/{claimId}/reject")
    public ResponseEntity<String> rejectClaim(@PathVariable Long claimId, @RequestBody(required = false) Map<String, String> body) {
        try {
            String remarks = (body != null) ? body.get("remarks") : null;
            String message = claimService.rejectClaim(claimId, remarks);
            return ResponseEntity.ok(message);
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Error: " + e.getMessage());
        }
    }
}

-------------

package com.example.policy.service;

import com.example.policy.entity.Claim;
import com.example.policy.dto.ClaimResponse;
import com.example.policy.entity.Policy;
import com.example.policy.repository.ClaimRepository;
import com.example.policy.repository.PolicyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ClaimService {

    @Autowired
    private ClaimRepository claimRepository;

    @Autowired
    private PolicyRepository policyRepository;

    public ClaimResponse submitClaim(Claim claim) {
        if (claim.getPolicyId() == null) {
            throw new RuntimeException("Policy ID is required");
        }

        Policy policy = policyRepository.findById(claim.getPolicyId())
                .orElseThrow(() -> new RuntimeException("Policy not found"));

        claim.setPolicy(policy);

        claim.setClaimDate(LocalDate.now());
        claim.setStatus("Pending");

        Claim savedClaim = claimRepository.save(claim);
        return convertToResponse(savedClaim);
    }

    public List<ClaimResponse> getAllClaims() {
        return claimRepository.findAllWithPolicy().stream()
                .map(this::convertToResponse)
                .collect(Collectors.toList());
    }

    public List<ClaimResponse> getClaimsByUser(Long userId) {
        return claimRepository.findByUserId(userId).stream()
                .map(this::convertToResponse)
                .collect(Collectors.toList());
    }

    public List<ClaimResponse> getPendingClaims() {
        return claimRepository.findByStatus("Pending").stream()
                .map(this::convertToResponse)
                .collect(Collectors.toList());
    }

    private ClaimResponse convertToResponse(Claim claim) {
        Policy p = claim.getPolicy();
        return new ClaimResponse(
                claim.getId(),
                p.getId(),
                p.getPlanName(),
                p.getInsuredAmount(),
                claim.getClaimType(),
                claim.getClaimAmount(),
                claim.getClaimDate(),
                claim.getStatus(),
                claim.getRemarks()
        );
    }

    public String approveClaim(Long claimId, String remarks) {
        if (claimId == null || claimId <= 0) {
            throw new IllegalArgumentException("Invalid Claim ID");
        }

        Claim claim = claimRepository.findById(claimId).orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Approved");
        if (remarks != null && !remarks.isBlank()) {
            claim.setRemarks(remarks);
        }

        claimRepository.save(claim);
        return "Claim " + claimId + " approved";
    }

    public String rejectClaim(Long claimId, String remarks) {
        if (claimId == null || claimId <= 0) {
            throw new IllegalArgumentException("Invalid Claim ID");
        }

        Claim claim = claimRepository.findById(claimId).orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Rejected");
        if (remarks != null && !remarks.isBlank()) {
            claim.setRemarks(remarks);
        }

        claimRepository.save(claim);
        return "Claim " + claimId + " rejected";
    }
}
