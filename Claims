package com.example.policy.entity;

import lombok.Data;
import jakarta.persistence.*;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
@Entity
@Table(name = "claims")
public class Claim {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long claimId;

    private Long policyId;  // Link to user's issued policy (from policies table)

    private String claimType;  // e.g., Death, Maturity, Accident

    private BigDecimal claimAmount;

    private LocalDate claimDate = LocalDate.now();  // Auto now

    private String status = "Pending";  // Pending, Approved, Rejected

    private String remarks;  // Reason of Claim
}
--------

<!-- Claims Table -->
<changeSet id="004-claims" author="you">
    <createTable tableName="claims">
        <column name="claim_id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="policy_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
        <column name="claim_type" type="VARCHAR(50)"/>
        <column name="claim_amount" type="DECIMAL(15,2)"/>
        <column name="claim_date" type="DATE"/>
        <column name="status" type="VARCHAR(20)"/>
        <column name="remarks" type="VARCHAR(255)"/>
    </createTable>
</changeSet>

-----------------------

<!-- Hardcoded 5 claims -->
<changeSet id="004-claims-data" author="you">
    <!-- Claim 1: Pending (Accident) -->
    <insert tableName="claims">
        <column name="policy_id" value="1"/>
        <column name="claim_type" value="Accident"/>
        <column name="claim_amount" value="250000"/>
        <column name="claim_date" value="2026-01-20"/>
        <column name="status" value="Pending"/>
        <column name="remarks" value="Minor Accident claim"/>
    </insert>

    <!-- Claim 2: Approved (Maturity) -->
    <insert tableName="claims">
        <column name="policy_id" value="2"/>
        <column name="claim_type" value="Maturity"/>
        <column name="claim_amount" value="800000"/>
        <column name="claim_date" value="2026-02-05"/>
        <column name="status" value="Approved"/>
        <column name="remarks" value="Maturity Claim Approved"/>
    </insert>

    <!-- Claim 3: Rejected (Hospitalization) -->
    <insert tableName="claims">
        <column name="policy_id" value="3"/>
        <column name="claim_type" value="Hospitalization"/>
        <column name="claim_amount" value="50000"/>
        <column name="claim_date" value="2026-02-09"/>
        <column name="status" value="Rejected"/>
        <column name="remarks" value="Rejected due to invalid documents"/>
    </insert>

    <!-- Claim 4: Pending (Health Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="4"/>
        <column name="claim_type" value="Health Insurance"/>
        <column name="claim_amount" value="120000"/>
        <column name="claim_date" value="2026-02-15"/>
        <column name="status" value="Pending"/>
        <column name="remarks" value="Hospitalization claim due to surgery"/>
    </insert>

    <!-- Claim 5: Pending (Motor Insurance) -->
    <insert tableName="claims">
        <column name="policy_id" value="5"/>
        <column name="claim_type" value="Motor Insurance"/>
        <column name="claim_amount" value="95000"/>
        <column name="claim_date" value="2026-02-18"/>
        <column name="status" value="Pending"/>
        <column name="remarks" value="Vehicle damage claim after road accident"/>
    </insert>
</changeSet>


---------

package com.example.policy.repository;

import com.example.policy.entity.Claim;
import org.springframework.data.jpa.repository.JpaRepository;

public interface ClaimRepository extends JpaRepository<Claim, Long> {
}

--------

package com.example.policy.service;

import com.example.policy.entity.Claim;
import com.example.policy.dto.ClaimResponse;
import com.example.policy.entity.Policy;
import com.example.policy.repository.ClaimRepository;
import com.example.policy.repository.PolicyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ClaimService {

    @Autowired
    private ClaimRepository claimRepository;

    @Autowired
    private PolicyRepository policyRepository;

    // User submits claim
    public Claim submitClaim(Claim claim) {
        if (claim.getPolicyId() == null) {
            throw new RuntimeException("Policy ID is required");
        }

        Policy policy = policyRepository.findById(claim.getPolicyId())
                .orElseThrow(() -> new RuntimeException("Policy not found"));

        claim.setClaimDate(LocalDate.now());
        claim.setStatus("Pending");

        return claimRepository.save(claim);
    }

    // Get all claims (for approver or read-only)
    public List<ClaimResponse> getAllClaims() {
        return claimRepository.findAll().stream()
                .map(this::convertToResponse)
                .collect(Collectors.toList());  // Java Streams for mapping to DTO
    }

    // Get my claims (for user)
    public List<ClaimResponse> getMyClaims(Long userId) {
        return claimRepository.findAll().stream()
                .filter(claim -> claim.getPolicyId() != null && policyRepository.findById(claim.getPolicyId())
                        .map(p -> p.getUserId().equals(userId)).orElse(false))
                .map(this::convertToResponse)
                .collect(Collectors.toList());  // Java Streams for filtering by userId
    }

    // Get pending claims (for approver)
    public List<ClaimResponse> getPendingClaims() {
        return claimRepository.findAll().stream()
                .filter(claim -> "Pending".equals(claim.getStatus()))
                .map(this::convertToResponse)
                .collect(Collectors.toList());  // Java Streams for filtering pending
    }

    // Convert Claim to ClaimResponse DTO (with policy details)
    private ClaimResponse convertToResponse(Claim claim) {
        Policy p = policyRepository.findById(claim.getPolicyId()).orElse(null);
        return new ClaimResponse(
                claim.getClaimId(),
                claim.getPolicyId(),
                p != null ? p.getPlanName() : null,
                p != null ? p.getInsuredAmount() : null,
                claim.getClaimType(),
                claim.getClaimAmount(),
                claim.getClaimDate(),
                claim.getStatus(),
                claim.getRemarks()
        );
    }

    // Approver approves claim
    public String approveClaim(Long claimId, String remarks) {
        Claim claim = claimRepository.findById(claimId)
                .orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Approved");
        claim.setRemarks(remarks);
        claimRepository.save(claim);
        return "Claim approved";
    }

    // Approver rejects claim
    public String rejectClaim(Long claimId, String remarks) {
        Claim claim = claimRepository.findById(claimId)
                .orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Rejected");
        claim.setRemarks(remarks);
        claimRepository.save(claim);
        return "Claim rejected";
    }
}
-------

package com.example.policy.service;

import com.example.policy.entity.Claim;
import com.example.policy.dto.ClaimResponse;
import com.example.policy.entity.Policy;
import com.example.policy.repository.ClaimRepository;
import com.example.policy.repository.PolicyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ClaimService {

    @Autowired
    private ClaimRepository claimRepository;

    @Autowired
    private PolicyRepository policyRepository;

    // User submits claim
    public Claim submitClaim(Claim claim) {
        if (claim.getPolicyId() == null) {
            throw new RuntimeException("Policy ID is required");
        }

        Policy policy = policyRepository.findById(claim.getPolicyId())
                .orElseThrow(() -> new RuntimeException("Policy not found"));

        claim.setClaimDate(LocalDate.now());
        claim.setStatus("Pending");

        return claimRepository.save(claim);
    }

    // Get all claims (for approver or read-only)
    public List<ClaimResponse> getAllClaims() {
        return claimRepository.findAll().stream()
                .map(this::convertToResponse)
                .collect(Collectors.toList());  // Java Streams for mapping to DTO
    }

    // Get my claims (for user)
    public List<ClaimResponse> getMyClaims(Long userId) {
        return claimRepository.findAll().stream()
                .filter(claim -> claim.getPolicyId() != null && policyRepository.findById(claim.getPolicyId())
                        .map(p -> p.getUserId().equals(userId)).orElse(false))
                .map(this::convertToResponse)
                .collect(Collectors.toList());  // Java Streams for filtering by userId
    }

    // Get pending claims (for approver)
    public List<ClaimResponse> getPendingClaims() {
        return claimRepository.findAll().stream()
                .filter(claim -> "Pending".equals(claim.getStatus()))
                .map(this::convertToResponse)
                .collect(Collectors.toList());  // Java Streams for filtering pending
    }

    // Convert Claim to ClaimResponse DTO (with policy details)
    private ClaimResponse convertToResponse(Claim claim) {
        Policy p = policyRepository.findById(claim.getPolicyId()).orElse(null);
        return new ClaimResponse(
                claim.getClaimId(),
                claim.getPolicyId(),
                p != null ? p.getPlanName() : null,
                p != null ? p.getInsuredAmount() : null,
                claim.getClaimType(),
                claim.getClaimAmount(),
                claim.getClaimDate(),
                claim.getStatus(),
                claim.getRemarks()
        );
    }

    // Approver approves claim
    public String approveClaim(Long claimId, String remarks) {
        Claim claim = claimRepository.findById(claimId)
                .orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Approved");
        claim.setRemarks(remarks);
        claimRepository.save(claim);
        return "Claim approved";
    }

    // Approver rejects claim
    public String rejectClaim(Long claimId, String remarks) {
        Claim claim = claimRepository.findById(claimId)
                .orElseThrow(() -> new RuntimeException("Claim not found"));

        if (!"Pending".equals(claim.getStatus())) {
            throw new RuntimeException("Claim is not pending");
        }

        claim.setStatus("Rejected");
        claim.setRemarks(remarks);
        claimRepository.save(claim);
        return "Claim rejected";
    }
}
-----------

// ClaimResponse.java (DTO for response â€“ uses streams in service for mapping)
package com.example.policy.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
public class ClaimResponse {

    private Long claimId;
    private Long policyId;
    private String planName;
    private BigDecimal insuredAmount;
    private String claimType;
    private BigDecimal claimAmount;
    private LocalDate claimDate;
    private String status;
    private String remarks;

}

-------
// ClaimController.java (REST endpoints for claim submission, view all/my/pending, approve/reject)
package com.example.policy.controller;

import com.example.policy.entity.Claim;
import com.example.policy.service.ClaimService;
import com.example.policy.dto.ClaimResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/claims")
public class ClaimController {

    @Autowired
    private ClaimService claimService;

    // User submits claim
    @PostMapping("/submit")
    public ClaimResponse submitClaim(@RequestBody Claim claim) {
        return claimService.submitClaim(claim);
    }

    // Get all claims
    @GetMapping("/retrieve")
    public List<ClaimResponse> getAllClaims() {
        return claimService.getAllClaims();
    }

    // User views their claims
    @GetMapping("/my")
    public List<ClaimResponse> getMyClaims(@RequestHeader("userId") Long userId) {
        return claimService.getMyClaims(userId);
    }

    // Approver views pending claims
    @GetMapping("/pending")
    public List<ClaimResponse> getPendingClaims() {
        return claimService.getPendingClaims();
    }

    // Approver approves claim
    @PutMapping("/{claimId}/approve")
    public ResponseEntity<String> approveClaim(@PathVariable Long claimId, @RequestBody(required = false) Map<String, String> body) {
        String remarks = (body != null) ? body.get("remarks") : null;
        String message = claimService.approveClaim(claimId, remarks);
        return ResponseEntity.ok(message);
    }

    // Approver rejects claim
    @PutMapping("/{claimId}/reject")
    public ResponseEntity<String> rejectClaim(@PathVariable Long claimId, @RequestBody(required = false) Map<String, String> body) {
        String remarks = (body != null) ? body.get("remarks") : null;
        String message = claimService.rejectClaim(claimId, remarks);
        return ResponseEntity.ok(message);
    }
}

