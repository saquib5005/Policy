package com.example.policy.service;

import com.example.policy.dto.PolicyRequest;
import com.example.policy.entity.Policy;
import com.example.policy.entity.User;
import com.example.policy.repository.PolicyRepository;
import com.example.policy.repository.UserRepository;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
public class PolicyService {

    @Autowired
    private PolicyRepository policyRepository;

    @Autowired
    private UserRepository userRepository;

    private final ObjectMapper mapper = new ObjectMapper();

    public Policy issuePolicy(PolicyRequest req) {
        Optional<User> optUser = userRepository.findById(req.getUserId());
        if (optUser.isEmpty()) {
            throw new RuntimeException("User not found");
        }

        User user = optUser.get();

        Policy policy = new Policy();
        policy.setUser(user);

        // Step a: Personal Details
        policy.setHolderName(req.getPersonalDetails().getName());
        policy.setHolderDob(req.getPersonalDetails().getDob());
        policy.setHolderAddress(req.getPersonalDetails().getAddress());

        // Step b: Income Details
        policy.setIncomeSource(req.getIncomeDetails().getSource());
        policy.setTotalIncome(req.getIncomeDetails().getTotal());

        // Step d: Policy Details
        policy.setPlanName(req.getPolicyDetails().getPlanName());
        policy.setPlanType(req.getPolicyDetails().getPlanType());
        policy.setCoverageLimit(req.getPolicyDetails().getCoverageLimit());
        policy.setTenureYears(req.getPolicyDetails().getTenureYears());
        policy.setPremiumFrequency(req.getPolicyDetails().getPremiumFrequency());
        policy.setInsuredAmount(req.getPolicyDetails().getInsuredAmount());
        policy.setIssuanceDate(req.getPolicyDetails().getIssuanceDate());

        // Auto-calculations
        if (policy.getIssuanceDate() != null && policy.getTenureYears() != null) {
            policy.setMaturityDate(policy.getIssuanceDate().plusYears(policy.getTenureYears()));
        }

        if (policy.getInsuredAmount() != null && policy.getPremiumFrequency() != null) {
            BigDecimal base = policy.getInsuredAmount().multiply(new BigDecimal("0.05"));
            switch (policy.getPremiumFrequency().toLowerCase()) {
                case "monthly" -> policy.setPremiumAmount(base.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP));
                case "quarterly" -> policy.setPremiumAmount(base.divide(new BigDecimal("4"), 2, RoundingMode.HALF_UP));
                case "half-yearly" -> policy.setPremiumAmount(base.divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP));
                default -> policy.setPremiumAmount(base);
            }
        }

        if (policy.getInsuredAmount() != null && policy.getTenureYears() != null) {
            BigDecimal mat = policy.getInsuredAmount()
                    .multiply(BigDecimal.valueOf(1.5))
                    .multiply(BigDecimal.valueOf(policy.getTenureYears() / 10.0));
            policy.setMaturityAmount(mat);
        }

        // Nominees and metadata (from your previous code)
        List<PolicyRequest.NomineeDetails> nominees = req.getNomineeDetails();
        if (nominees != null && !nominees.isEmpty()) {
            try {
                policy.setNomineesJson(mapper.writeValueAsString(nominees));
            } catch (JsonProcessingException e) {
                throw new RuntimeException("Failed to convert nominees to JSON", e);
            }
        } else {
            policy.setNomineesJson("[]");
        }

        // Metadata
        policy.setApprovalTimestamp(LocalDate.now());
        policy.setApproverName("System");
        policy.setAssignmentDetails("Assigned to " + user.getName());

        return policyRepository.save(policy);
    }

    public List<Policy> getAllPolicies() {
        return policyRepository.findAll();
    }
}


------------



package com.example.policy.controller;

import com.example.policy.dto.PolicyRequest;
import com.example.policy.entity.Policy;
import com.example.policy.service.PolicyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/policies")
public class PolicyController {

    @Autowired
    private PolicyService policyService;

    // SuperUser creates policy template
    @PostMapping("/create")
    public Policy createPolicy(@RequestBody PolicyRequest req) {
        return policyService.createPolicy(req);
    }

    // View all policies
    @GetMapping
    public List<Policy> getAllPolicies() {
        return policyService.getAllPolicies();
    }

    // Read-Only view all policies with metadata
    @GetMapping("/read-only")
    public List<Policy> getAllPoliciesForReadOnly() {
        return policyService.getAllPolicies();
    }

    // Delete policy
    @DeleteMapping("/{id}")
    public String deletePolicy(@PathVariable Long id) {
        policyService.deletePolicy(id);
        return "Policy deleted";
    }
}

---------

package com.example.policy.controller;

import com.example.policy.dto.PolicyView;
import com.example.policy.entity.Policy;
import com.example.policy.service.PolicyService;
import com.example.policy.dto.PolicyRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import com.example.policy.repository.PolicyRepository;

import java.util.List;

@RestController
@RequestMapping("/api/policies")
public class PolicyController {

    @Autowired
    private PolicyService policyService;

    @Autowired
    private PolicyRepository policyRepository;

    @PostMapping("/create")
    public Policy createPolicy(@RequestBody PolicyRequest req) {
        return policyService.issuePolicy(req);
    }

    @GetMapping
    public List<Policy> getAllPolicies() {
        return policyService.getAllPolicies();
    }

    @GetMapping("/read-only")
    public List<Policy> getAllPoliciesForReadOnly() {
        return policyRepository.findAll();
    }

    @GetMapping("/super-view")
    public List<PolicyView> getSuperUserPolicies(@RequestHeader("userId") Long superUserId) {
        return policyService.getSuperUserPolicies(superUserId);
    }
}


----------


package com.example.policy.controller;

import com.example.policy.dto.PolicyView;
import com.example.policy.entity.Policy;
import com.example.policy.service.PolicyService;
import com.example.policy.dto.PolicyRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import com.example.policy.repository.PolicyRepository;

import java.util.List;

@RestController
@RequestMapping("/api/policies")
public class PolicyController {

    @Autowired
    private PolicyService policyService;

    @Autowired
    private PolicyRepository policyRepository;

    @PostMapping("/create")
    public Policy createPolicy(@RequestBody PolicyRequest req) {
        return policyService.issuePolicy(req);
    }

    @GetMapping
    public List<Policy> getAllPolicies() {
        return policyService.getAllPolicies();
    }

    @GetMapping("/read-only")
    public List<Policy> getAllPoliciesForReadOnly() {
        return policyRepository.findAll();
    }

    @DeleteMapping("/{policyId}")
    public String deletePolicy(@PathVariable Long policyId) {
        policyRepository.deleteById(policyId);
        return "Policy Deleted";
    }

    @GetMapping("/super-view")
    public List<PolicyView> getSuperUserPolicies(@RequestHeader("userId") Long superUserId) {
        return policyService.getSuperUserPolicies(superUserId);
    }
}
